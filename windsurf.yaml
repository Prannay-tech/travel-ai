name: Travel AI ETL Pipeline
description: Automated data pipeline for travel recommendations

schedules:
  - name: daily-etl
    cron: "0 2 * * *"  # Run daily at 2 AM UTC
    tasks:
      - name: fetch-places
        command: python etl/run.py --mode places
        timeout: 1800  # 30 minutes
        retries: 3
        
      - name: fetch-flights
        command: python etl/run.py --mode flights
        timeout: 1800  # 30 minutes
        retries: 3
        
      - name: generate-embeddings
        command: python etl/embed.py
        timeout: 3600  # 1 hour
        retries: 2
        depends_on:
          - fetch-places
          - fetch-flights

  - name: enhanced-daily-pipeline
    cron: "0 3 * * *"  # Run daily at 3 AM UTC
    tasks:
      - name: enhanced-etl-pipeline
        command: python etl/enhanced_etl_pipeline.py
        timeout: 3600  # 1 hour
        retries: 3
        environment:
          SUPABASE_URL: "${SUPABASE_URL}"
          SUPABASE_KEY: "${SUPABASE_KEY}"
          OPENTRIPMAP_API_KEY: "${OPENTRIPMAP_API_KEY}"

  - name: weekly-full-pipeline
    cron: "0 4 * * 0"  # Run weekly on Sunday at 4 AM UTC
    tasks:
      - name: full-etl-pipeline
        command: python etl/run.py --mode full
        timeout: 7200  # 2 hours
        retries: 3

  - name: health-check
    cron: "*/30 * * * *"  # Every 30 minutes
    tasks:
      - name: check-backend-health
        command: curl -f http://localhost:8000/health
        timeout: 60
        retries: 2

environment:
  python_version: "3.9"
  working_directory: "/app"
  
  variables:
    SUPABASE_URL: "${SUPABASE_URL}"
    SUPABASE_KEY: "${SUPABASE_KEY}"
    OPENTRIPMAP_API_KEY: "${OPENTRIPMAP_API_KEY}"
    AMADEUS_API_KEY: "${AMADEUS_API_KEY}"
    
  volumes:
    - ./data:/app/data
    - ./logs:/app/logs

notifications:
  - type: email
    to: ["admin@travel-ai.com"]
    on: ["failure", "success"]
    
  - type: slack
    webhook_url: "${SLACK_WEBHOOK_URL}"
    on: ["failure"]

monitoring:
  metrics:
    - name: places_processed
      type: counter
      description: "Number of places processed"
      
    - name: flights_processed
      type: counter
      description: "Number of flights processed"
      
    - name: embeddings_generated
      type: counter
      description: "Number of embeddings generated"
      
    - name: destinations_processed
      type: counter
      description: "Number of destinations processed"
      
    - name: pipeline_duration
      type: histogram
      description: "Pipeline execution time"
      
  alerts:
    - name: pipeline_failure
      condition: "pipeline_status == 'failed'"
      action: "notify"
      
    - name: high_error_rate
      condition: "error_rate > 0.1"
      action: "notify"
      
    - name: slow_pipeline
      condition: "pipeline_duration > 3600"
      action: "notify" 